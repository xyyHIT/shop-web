<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>商品管理</title>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no">
    <script src="/shop/js/rem.js"></script>
    <link href="/shop/css/base.css" rel="stylesheet" type="text/css" />
    <link href="/shop/css/font/iconfont.css" rel="stylesheet" type="text/css" />
    <style>

        .trade{ position: fixed; top: 0; left: 0; width: 100%; line-height:4rem; border-bottom: 1px solid #EFEFEF; background: #fff; z-index: 222;}
        .trade span{width:33.33%; position: relative; text-align: center; font-size: 1.3rem; display: inline-block; color:#3C3C3C;}
        .trade span.current{color:#ec4747; border-bottom:2px solid #ec4747 }

        .header{padding: 1rem 1.5rem;background-color:#fff; margin-top:4.5rem;position: relative;z-index: 200;}
        .header input{font-size:1.1rem;color:#9e9e9e;float:left;height:2.5rem;width:21.9rem;padding-left:3rem;background:#e7e7e7;border:none;border-radius:5px;background-size: 1.6rem;background-position-y: 0.3rem;background-position-x: 0.5rem;}
        #search-button{float:right;border-radius:4px; border:1px solid #5f5f5f;width:6rem;height:2.5rem;display: inline-block;text-align: center;line-height: 2.5rem;font-size: 1.1rem;color:#5f5f5f;}
        .searchBg{position: absolute; top:1.5rem; left:2rem; font-size: 1.3rem; color:#6e6e6e;}

        .goodsList{margin-top:.5rem; }
        .goodsList .goodsContent{height:10rem; background: #fff;padding:0 1.5rem;}
        .goodsList .goodsContent a{width:100%; height:100%; overflow: hidden; display: inline-block;}
        .goodsList .goodsContent dl{padding-top:1.5rem; overflow: hidden;}
        .goodsList .goodsContent dl dt{width:7rem; height: 7rem; margin-right:1.5rem; border-radius: 5px;}
        .goodsList .goodsContent dl dt img{width:100%;}
        .goodsList .goodsContent dl dd{}
        .goodsList .goodsContent dl dd .title{font-size: 1.2rem; color:#3c3c3c; padding-top:.5rem; line-height: 2rem;}
        .goodsList .goodsContent dl .repertory{color:#aaa;font-size: 1.2rem; margin-right:2rem;}
        .goodsList .goodsContent dl .num{margin-top:.3rem;}
        .goodsList .goodsContent dl .warn{width:5rem; text-align: center; background: #ec4747;font-size: 1rem; color:#fff; height:2rem; line-height: 2rem; display: inline-block; border-radius: 25px;}
        .handle{margin-top:1px;}
        .handle ul{ background: #fff; overflow: hidden; padding:1rem 0;}
        .handle ul li{ float: left; width:33.33%; text-align: center;}
        .handles ul li{ width:50%;}
        .handle ul li .iconfont{ font-size: 1.9rem;}
        .handle ul li .icon-shanchu71{color:#b5bac0;}
        .handle ul li .icon-bianji{color:#ffc77e;}
        .handle ul li .icon-xiajia{color:#6aabd3;}
        .handle ul li .icon-shangjia{color:#ec4747;}
        .sketch{color:#878787; font-size: 1.1rem;margin-top:.3rem;}
    </style>
</head>
<body>
<div class="container">
    <div class="trade">
        <span data_t="1">出售中</span><span data_t="0">已下架</span><span data_t="2">草稿</span>
    </div>
    <div class="header fix">
        <div class="searchBg iconfont icon-sousuo"></div>
        <form action="javascript:void(0)">
            <input type="search" id="searchInput" placeholder="输入搜索的商品名称..." autocapitalize="off" autocorrect="off">
        </form>
        <span id="search-button">搜索</span>
    </div>
    <div class="trade_contents">
        <!--<div class='goodsList'>
            <div class='goodsContent'>
                <a href=''>
                    <dl>
                        <dt class='left'><img src='' /></dt>
                        <dd>
                            <p class='over over1 title'>输入搜索的商品名称</p>
                            <p class='price title'>$2000</p>
                            <p class='num'><span class='repertory'>库存1000</span><span class='warn'>库存预警</span></p>
                        </dd>
                    </dl>
                </a>
            </div>
            <div class='handle'>
                <ul>
                    <li class="del">
                      <div class="iconfont icon-shanchu71"></div>
                        <div class="sketch">删除</div>
                    </li>
                    <li class="redact">
                        <div class="iconfont icon-bianji"></div>
                        <div class="sketch">编辑</div>
                    </li>
                    <li class="Unshelve">
                        <div class="iconfont icon-xiajia"></div>
                        <div class="sketch">下架</div>
                    </li>
                </ul>
            </div>
        </div>
        <ol>
            <div class="goodsList">
                <div class="goodsContent">
                    <a href="javascript:;">
                        <dl>
                            <dt class="left"><img src="" alt=""></dt>
                            <dd class="">
                                <p class="over over1 title">输入搜索的商品名称</p>
                                <p class="price title">$2000</p>
                                <p class="num"><span class="repertory">库存1000</span></p>
                            </dd>
                        </dl>
                    </a>
                </div>
                <div class="handle">
                    <ul>
                        <li>
                            <div class="iconfont icon-shanchu71 del"></div>
                            <div class="sketch">删除</div>
                        </li>
                        <li>
                            <div class="iconfont icon-bianji redact"></div>
                            <div class="sketch">编辑</div>
                        </li>
                        <li class="shelve">
                            <div class="iconfont icon-shangjia"></div>
                            <div class="sketch">上架</div>
                        </li>
                    </ul>
                </div>
            </div>
        </ol>
        <ol>
            <div class="goodsList">
                <div class="goodsContent">
                    <a href="javascript:;">
                        <dl>
                            <dt class="left"><img src="" alt=""></dt>
                            <dd class="">
                                <p class="over over1 title">输入搜索的商品名称</p>
                                <p class="price title">$2000</p>
                                <p class="num"><span class="repertory">库存1000</span><span class="warn">库存预警</span></p>
                            </dd>
                        </dl>
                    </a>
                </div>
                <div class="handle handles">
                    <ul>
                        <li>
                            <div class="iconfont icon-shanchu71 del"></div>
                            <div class="sketch">删除</div>
                        </li>
                        <li>
                            <div class="iconfont icon-bianji redact"></div>
                            <div class="sketch">编辑</div>
                        </li>

                    </ul>
                </div>
            </div>
        </ol>-->
    </div>
</div>
</body>

<script src="/shop/js/jquery-2.1.4.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="/shop/js/public.js"></script>
<script src="/shop/js/fastclick.js"></script>
<script>
	var linkType = allFun.getRequest("linkType"),//tab类型
		curr_page = 1,
		finished = true;
    $(function () {
    	if(!linkType){
    		linkType = 1;
    	}
    	getGoodsList(linkType,"");
    	
    	$(".trade span").each(function(){
			if($(this).attr("data_t") == linkType){
				$(this).addClass("current").siblings().removeClass("current");
			}
		})
    	//tab切换
		$(".trade span").click(function () {
			linkType = $(this).attr("data_t");
	        $(this).addClass("current").siblings().removeClass("current");
	        $(".trade_contents").empty();
	        curr_page = 1;
	        getGoodsList(linkType,"");
	    })
		//点击查看更多
		$(window).on('scroll', function () {
			var dHeight = document.documentElement.offsetHeight;
            var sHeight = document.documentElement.scrollTop || document.body.scrollTop;
            var wHeight = document.documentElement.clientHeight;
            if (finished && dHeight - (sHeight + wHeight) < 200) {
            	finished = false;
            	if($(".seemore").attr("data_d") != "no"){
            		curr_page++;
            		getGoodsList(linkType,"");
            	}
            }
		})
		
		//点击搜索按钮
        $("body").on('click',"#search-button",function(){
            var keyword=$("#searchInput").val();
            if(keyword==""){
                allFun.alertDiv("请输入搜索内容");
                return false;
            }
            $(".trade_contents").empty();
            curr_page = 1;
            getGoodsList(linkType,keyword);
        });
        //点击虚拟按键搜索
        $(document).keydown(function (event){
            if(event.keyCode === 13) {
                var keyword=$("#searchInput").val();
	            if(keyword==""){
	                allFun.alertDiv("请输入搜索内容");
	                return false;
	            }
	            $(".trade_contents").empty();
	            curr_page = 1;
	            getGoodsList(linkType,keyword);
            }
        });
		
        //删除
        $("body").on("click",".handle li.del",function(){
        	if(confirm("确定删除吗？")){
        		var _t = $(this),
	        		id = _t.parents(".handle").attr("data_id");
	        	$.ajax({
					url: host+'/index.php?app=my_goods&act=ejDrop',
					type: "post",
					data:{"id":id},
					dataType: "json",
					beforeSend:function(){
						allFun.loading("正在删除中");
					},
					success: function(rs) {
						allFun.removeLoading();
						if (rs.code == 0) {
							allFun.alertDiv("已成功删除！");
							_t.parents(".goodsList").remove();
						}else{
							allFun.alertDiv(rs.msg);
						}
					}
				})
        	}
		})
        //编辑
        $("body").on("click",".handle li.redact",function(){
        	var id = $(this).parents(".handle").attr("data_id");
        	location.href = "/shop/html/my/publish.html?id="+id;
		})
        //下架
        $("body").on("click",".handle li.Unshelve",function(){
        	if(confirm("确定下架吗？")){
        		var _t = $(this),
	        		id = _t.parents(".handle").attr("data_id");
	        	$.ajax({
					url: host+'/index.php?app=my_goods&act=ajax_col&column=if_show',
					type: "post",
					data:{"id":id,"value":0},//0 -> 下架 1 -> 上架  2 -> 草稿
					dataType: "json",
					beforeSend:function(){
						allFun.loading("正在下架中");
					},
					success: function(rs) {
						allFun.removeLoading();
						if (rs.code == 0) {
							allFun.alertDiv("已成功下架！");
							_t.parents(".goodsList").remove();
						}else{
							allFun.alertDiv(rs.msg);
						}
					}
				})
        	}
		})
        //上架
        $("body").on("click",".handle li.shelve",function(){
        	var _t = $(this),
        		id = _t.parents(".handle").attr("data_id");
        	$.ajax({
				url: host+'/index.php?app=my_goods&act=ajax_col&column=if_show',
				type: "post",
				data:{"id":id,"value":1},//0 -> 下架 1 -> 上架  2 -> 草稿
				dataType: "json",
				beforeSend:function(){
					allFun.loading("正在上架中");
				},
				success: function(rs) {
					allFun.removeLoading();
					if (rs.code == 0) {
						allFun.alertDiv("已成功上架！");
						_t.parents(".goodsList").remove();
					}else{
						allFun.alertDiv(rs.msg);
					}
				}
			})
		})
    });
    
    //获取数据
    function getGoodsList(if_show,keyword){
    	$.ajax({//if_show 0 -> 下架 1 -> 上架  2 -> 草稿      keyword关键词
			url: host + "/index.php?app=my_goods&act=ejIndex&if_show="+if_show+"&keyword="+keyword+"&page="+curr_page+"",
			type: "get",
			dataType: "json",
			beforeSend:function(){
				if(curr_page == 1){//第一次
					allFun.loading();
				}
			},
			success: function(rs) {
				allFun.removeLoading();
				if(rs.code == 0) {
					$(".seemore").remove();
					curr_page = rs.data.page.curr_page;
					finished = true;
					var obj = "",
						d = rs.data.goods,
						item_count = rs.data.page.item_count,//总条数
						pageper = rs.data.page.pageper;//每页条数
					
					if(item_count == 0){//无数据(第一次进来)
						obj += allFun.noDataImg("没有宝贝，还不赶紧去发布？");
					}else{
						for(var i = 0; i < d.length; i++){
							obj += "<div class='goodsList'><div class='goodsContent'>";
							if(if_show == 2){//草稿
								obj += "<a href=/shop/html/my/publish.html?id="+d[i].goods_id+">";
							}else{
								obj += "<a href=/shop/html/index/goodsDetails.html?goodsId="+d[i].goods_id+">";
							}
							obj += "<dl><dt class='left'><img src="+d[i].default_image+"/square /></dt><dd>"
								+ "<p class='over title'>"+d[i].goods_name+"</p>"
								+ "<p class='price title'>¥"+d[i].price+"</p><p class='num'>"
								+ "<span class='repertory'>库存"+d[i].stock+"</span></p></dd></dl></a></div>";
							if(if_show == 1){//出售中
								obj+= "<div class='handle handles' data_id="+d[i].goods_id+"><ul>"
									+ "<li class='del'><div class='iconfont icon-shanchu71'></div><div class='sketch'>删除</div></li>"
									+ "<li class='Unshelve'><div class='iconfont icon-xiajia'></div><div class='sketch'>下架</div></li></ul></div>"
							}
							if(if_show == 0){//已下架
								obj+= "<div class='handle' data_id="+d[i].goods_id+"><ul>"
									+ "<li class='del'><div class='iconfont icon-shanchu71'></div><div class='sketch'>删除</div></li>"
									+ "<li class='redact'><div class='iconfont icon-bianji'></div><div class='sketch'>编辑</div></li>"
									+ "<li class='shelve'><div class='iconfont icon-shangjia'></div><div class='sketch'>上架</div></li></ul></div>"
							}
							if(if_show == 2){//草稿
								obj+= "<div class='handle handles' data_id="+d[i].goods_id+"><ul>"
									+ "<li class='del'><div class='iconfont icon-shanchu71'></div><div class='sketch'>删除</div></li>"
									+ "<li class='redact'><div class='iconfont icon-bianji'></div><div class='sketch'>编辑</div></li></ul></div>"
							}
							obj += "</div>";
						}
						
						if(curr_page < Math.ceil(item_count/pageper)){//有数据
							obj += "<div class='seemore'><div class='com-loading'><div></div></div>拼命加载中</div>";
						}else{//没有更多数据
							obj += "<div class='seemore' data_d='no'>没有更多</div>";
						}
					}
					$(".trade_contents").append(obj);
				} else {
					allFun.alertDiv(rs.msg);
				}
			},
			error: function() {
				allFun.removeLoading();
				allFun.alertDiv("error!")
			}
		})
    }
</script>
</html>