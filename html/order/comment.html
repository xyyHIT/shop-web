<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>发表评价</title>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no">
    <script src="/shop/js/rem.js"></script>
    <link href="/shop/css/base.css" rel="stylesheet" type="text/css" />
    <link href="/shop/css/font/iconfont.css" rel="stylesheet" type="text/css" />
    <script src="/shop/css/font/iconfont.js"></script>
    <link href="/shop/css/order.css" rel="stylesheet" type="text/css" />
    <style>
        .container{}
        .storeComment,.allStar,store{background: #fff;padding:0 1rem;}
        .allStar{padding-bottom:1rem;}
        .storeComment h1{color:#333; font-size:1.2rem;  padding:1rem 0 1.5rem 0;}
        .storeComment h1 em{ width: 2rem; height: 2rem;display:inline-block;float:left; margin-right:1rem;background: url(/shop/imgs/icon/store.png) no-repeat ; background-size: 100%;}
        .storeComment span{color:#dcdcdc; font-size:1rem;margin-left:1rem;}

        .stars{color:#dcdcdc;height:3rem;line-height: 3rem;font-size:1.2rem ;}
        .tip{position:absolute;top:0;left:0;z-index:9999;border: 1px solid #D6D6D6;padding:5px 12px;background-color: #FFF;display: none;color:#FF6600;}
        .intro{margin-left:8px;color:#1B1B1B}
        .stars img{vertical-align: middle;position: relative;top:-1px;cursor:pointer; width:1.9rem; height:1.9rem; display: inline-block; margin-right:.2rem;}
        .stars label{display: inline-block;color:#333;float: left; margin-right:1rem;}
        .comment_title{margin-left:1rem;display: inline-block}
        .area{margin-left:1rem;}

        .evaluation{padding:1rem; background: #fff;  overflow: hidden;}
        .evaluation dt{ float: left; width:6rem; height:6rem; margin-right:2rem;}
        .evaluation dt img{width:6rem; height:6rem;}
        .evaluation dd {float: left;}
        .evaluation dd h1{margin-top:1rem;font-size: 1.2rem;}

        .divOneInfo{ backgrund:#fff;margin:1rem 0;}
        .divOneInfo .imgList{ height: 6.5rem; background: #fff; overflow: hidden;}
        .divOneInfo .imgList li{font-size: 1.2rem; color:#333;width: 5rem; height: 5rem; line-height: 6rem;position: relative;
            float: left;margin-left: 1rem;}
        .divOneInfo .imgList li.uploadImg{ float: left; width: 5rem; height: 5rem; margin: 1rem 1rem 1.5rem 1.2rem;}
        .divOneInfo .imgList li img{ width:100%;}
        .divOneInfo .imgList li i.up{ position: absolute; display: block; width: 4.5rem; height: 4.5rem; top: 0; right: 0; background: url(/shop/imgs/icon/icon_up.png) no-repeat; background-size: 100%;}
        .divOneInfo .imgList li i.up{ font-size: 4.9rem; }
        .divOneInfo .imgList li i.iconCha{ position: absolute; display: block; width: 1.5rem; height: 1.5rem; top: 0; right: 0; background: url(/shop/imgs/icon/icon_cha.png) no-repeat; background-size: 100%;}
        .divOneInfo .imgList li i.iconfont{ font-size: 4.9rem; color: #979797;}
        .divOneInfo .imgList div.ph{float: left; line-height: 6rem;}


        .describe{background: #f9f9f9; padding:1rem; }
        .describe #fontContent{ width: 100%;background: #f9f9f9;  height: 8.5rem;   font-size: 1.2rem;  line-height: 1.8rem;  border:none;  border-radius: 5px;}

        .footer { display: none;}
        .present{width: 100%;height:4.9rem; line-height: 4.9rem; background: #ec4747; position: fixed; bottom:0; left: 0; text-align: center; color:#fff; font-size: 1.3rem;}
    </style>
</head>
<body>
<div class="container">
    <!--商品评价-->
    <div class="comList">
        <!--<dl class="evaluation">
            <dt ><img src="/shop/imgs/banner4.jpg"/></dt>
            <dd>
                <h1>商品评价</h1>
                <div class="stars goodComment">
                    <img src="/shop/imgs/star_gold.png"/>
                    <img src="/shop/imgs/star_gold.png"/>
                    <img src="/shop/imgs/star_gold.png"/>
                    <img src="/shop/imgs/star_gold.png"/>
                    <img src="/shop/imgs/star_gold.png"/>
                    <span class='area'>非常符合</span>
                </div>
            </dd>
        </dl>

        <div class="describe">
            <textarea id="fontContent" class="fontContent" placeholder="请输入内容,不超过100个字的购买体会和使用感受来帮助其他买家"></textarea>
        </div>-->
       <!-- <div class="divOneInfo">
            <ul class="imgList fix">
                <li>
                    <img src='../../imgs/test/0.jpg' />
                    <i class='iconCha'></i>
                </li>
                <li class='uploadImg'>
                    <i class='up'></i>
                </li>
                <div class="ph" >发照片，最多上传五张！</div>
            </ul>
        </div>-->
    </div>


    <!--店铺评价-->
    <div class="store">
        <div class="storeComment">
            <h1><em></em>店铺评分<span>满意请给打五分~</span></h1>
        </div>
        <div class="allStar">
            <div class="stars describes">
                <label>描述相符</label>
                <img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/>
            </div>
            <div class="stars logistics">
                <label>物流服务</label>
                <img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/>
            </div>
            <div class="stars manner" >
                <label>服务态度</label>
                <img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/><img src="/shop/imgs/star_gray.png"/>
            </div>
        </div>
    </div>

    <div class="present">提交评价</div>

</div>
</body>
<script src="/shop/js/jquery-2.1.4.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="/shop/js/public.js"></script>
<script src="/shop/js/fastclick.js"></script>
<script type="text/javascript">
    $(function() {
        var orderId = allFun.getRequest("order_id");type = allFun.getRequest("type");//商品id
        //评分
       function start() {
        //定义三维数组
        var data = [
            [
                ['不符合'],['一般'], ['符合' ], ['很符合'], ['非常符合']
            ],
            [
                ['很差'], ['一般'], ['好' ], ['很好'], ['非常好']
            ],
            [
                ['很差'], ['一般'], ['好' ], ['很好'], ['非常好']
            ]
        ];
        //定义悬浮每行各个星星图片
        var stars = [
            ['star_gold.png', 'star_gray.png', 'star_gray.png', 'star_gray.png', 'star_gray.png'],
            ['star_gold.png', 'star_gold.png', 'star_gray.png', 'star_gray.png', 'star_gray.png'],
            ['star_gold.png', 'star_gold.png', 'star_gold.png', 'star_gray.png', 'star_gray.png'],
            ['star_gold.png', 'star_gold.png', 'star_gold.png', 'star_gold.png', 'star_gray.png'],
            ['star_gold.png', 'star_gold.png', 'star_gold.png', 'star_gold.png', 'star_gold.png']
        ];

        $(".goodComment").find("img").click(function () {

        });
        $(".stars").find("img").click(function() { //当点击每颗星星
            var obj = $(this);//当前对象
            var star_area = obj.parent(".stars"); //当前父级.stars
            var star_area_index = star_area.parent().find(".stars").index(star_area);//当前父级.stars索引
            var index = obj.parent(".stars").find("img").index($(this));//当前星星索引

            var comment_title = data[star_area_index][index][0];//标题
            var comment_description = data[star_area_index][index][1];//描述
            star_area.attr("data-default-index", index);//记录点击后的索引，用来鼠标移出星星后，获取之前点击后的星星索引
            for (var i = 0; i < 5; i++) {
                star_area.find("img").eq(i).attr("src", "/shop/imgs/" + stars[index][i]);//切换每个星星
            }
            star_area.find(".comment_description").remove();//显示切换描述
            star_area.append("<span class='comment_description'><span class='comment_title'>" + comment_title + "</span></span>");
        });

    }
        start();
        //购买商品列表
          getOrderDetail();
        function getOrderDetail(){
            $.ajax({
                url: host + '/index.php?app=buyer_order&act=view',
                type: "get",
                dataType: "json",
                data:{"order_id":orderId,"type":0},
                beforeSend:function(){
                    allFun.loading();
                },
                success: function(rs) {
                    allFun.removeLoading();
                    if(rs.code == 0) {

                        var d = rs.data, obj = "";
                        $.each(d.goods_list, function(i,v) {
                            obj +='<div class="content" rec_id='+v.rec_id+'>'
                            obj += '<dl class="evaluation">'
                                + '<dt><a href=/shop/html/index/goodsDetails.html?goodsId='+v.goods_id+'><img src='+v.goods_image+'/square /></a></dt>'
                                + '<dd><h1>商品评价</h1>'
                                + '<div class="stars goodComment" data-default-index="4">'
                                + '<img src="/shop/imgs/star_gold.png"/>' +
                                '<img src="/shop/imgs/star_gold.png"/>' +
                                '<img src="/shop/imgs/star_gold.png"/>' +
                                '<img src="/shop/imgs/star_gold.png"/>' +
                                '<img src="/shop/imgs/star_gold.png"/>'
                                + '</div> </dd></dl>';
                            obj += '<div class="describe">'
                                + '<textarea id="fontContent" class="fontContent" placeholder="请输入内容,不超过100个字的购买体会和使用感受来帮助其他买家"></textarea>'
                                + '</div>';

                            obj += '<div class="divOneInfo">'
                                + '<ul class="imgList fix">'
                                + '<li class="uploadImg"><i class="up"></i></li>'
                                + '<div class="ph">发照片，最多上传五张！</div>'
                                + '</ul>'
                                + '</div>';
                            obj +='</div>';
                        });

                        $(".comList").html(obj);
                        start();
                    }
                },
                error: function() {
                    allFun.removeLoading();
                    allFun.alertDiv("error!")
                }
            })
        }

    //订单评价上传图片
       /* $(".content .imgList li.uploadImg").each(function() {
            $(this).click(function() {
         alert("ddd")

            });
        });*/

        $("body").on("click",".uploadImg",function(){
            var _t = $(this);
                wx.ready(function() {
                    var count = 5 - $(".imgList img").length,
                        images = {
                            localId: [],
                            serverId: []
                        };
                    wx.chooseImage({
                        count: count, // 默认9
                        sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                        sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                        success: function(res) {
                            images.localId = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                            var	i = 0,
                                len = images.localId.length;
                            if (len == 0) {
                                return;
                            }
                            allFun.uploadImgPrompt(1,len);
                            function upload(){
                                wx.uploadImage({
                                    localId: images.localId[i],
                                    isShowProgressTips: 0, // 默认为1，显示进度提示
                                    success: function(res) {
                                        i++;
                                        allFun.uploadImgPrompt(i,len);
                                        images.serverId.push(res.serverId);

                                        if (i < len) {
                                            upload();
                                        } else {
                                            $.ajax({
                                                url: host+'/index.php?app=comupload&act=ejUploadFile4Wechat&belong=4',
                                                type: "post",
                                                data: {
                                                    'mediaID': images.serverId.join(",")
                                                    //"id":id || ""
                                                },
                                                dataType: "json",
                                                success: function(rs) {
                                                    if (rs.code == 0) {
                                                        var data = rs.data,obj = "";

                                                        $.each(data, function(i,v) {
                                                            if(v.code != -1){
                                                                obj += "<li><img src="+v.file_path+"/square data_id="+v.file_id+" data_initSrc="+v.file_path+" /><i class='iconCha'></i></li>";
                                                            }
                                                        });
                                                        allFun.removeUploadImgPrompt();
                                                        if(obj == ""){
                                                            return false;
                                                        }
                                                        _t.before(obj);
                                                        $(".ph").hide();

                                                    } else {
                                                        allFun.alertDiv(rs.msg);
                                                    }
                                                }
                                            });
                                        }
                                    },
                                    fail: function(res) {
                                        allFun.removeUploadImgPrompt();
                                        allFun.alertDiv("上传超时，请重试！");
                                        //alert(JSON.stringify(res));
                                    }
                                });
                            }
                            upload();
                        }
                    });
                })
            });



    //查看大图
    $("body").on("click",".imgList img",function(){
        var imgList=[], targetSrc=$(this).attr("data_initSrc");
        $(this).parents(".imgList").find("img").each(function(){
            imgList.push($(this).attr("data_initSrc"))
        });
        wx.ready(function(){
            wx.previewImage({
                current: targetSrc, // 当前显示图片的http链接
                urls: imgList // 需要预览的图片http链接列表
            });
        })
    });

    //删除订单评价图片
    $("body").on("click",".imgList i.iconCha",function(){
        var _t = $(this);
        $.ajax({
            url: host+'/index.php?app=buyer_order&act=ejDropImage',
            type: "post",
            data: {
                'file_id': _t.parents("li").find("img").attr("data_id")
            },
            dataType: "json",
            beforeSend:function(){
                allFun.loading("正在删除中！");
            },
            success: function(rs) {
                allFun.removeLoading();
                if(rs.code == 0){
                    _t.parents("li").remove();
                    if(_t.parents("imgList").find("img").length==0){
                        $(".ph").show();
                    }
                }else{
                    allFun.alertDiv(rs.msg);
                }
            }
        })
    });


    //点击提交评价
    $("body").on("click",".present",function(){
        //获取评分所对应的星级个数
        var goodComment=$(".goodComment").attr("data-default-index"),desc_stars = $(".describes").attr("data-default-index"),logi_stars = $(".logistics").attr("data-default-index"),serv_stars = $(".manner").attr("data-default-index");
            /*
            if(goodComment==undefined){
               allFun.alertDiv("请对商品做出评价！");
               return false;
            }*/
            var fontContent = $(".fontContent").val();
            if(fontContent==''){
                allFun.alertDiv("请输入购买体会和使用感受！");
                return false;
            }
            if(desc_stars==undefined){
                allFun.alertDiv("请对商品描述做出评价！");
                return false;
                }
            if(logi_stars==undefined){
                allFun.alertDiv("请对物流服务做出评价！");
                return false;
            }
            if(serv_stars==undefined){
                allFun.alertDiv("请对服务态度做出评价！");
                return false;
            }


              var obj={},img=[],row = {};
                $(".imgList li img").each(function(){
                    img.push($(this).attr("data_id"));
                });
                 $(".comList .content").each(function(){
                    var _t = $(this);
                    row[$(this).attr("rec_id")] = {"evaluation":parseInt(_t.find(".goodComment").attr("data-default-index"))+1,"comment":_t.find(".fontContent").val(),"img_id":img.join()};
                });
                    comment(orderId,desc_stars,logi_stars,serv_stars,JSON.stringify(row));
                })
            });

    function  comment(orderId,desc_stars,logi_stars,serv_stars,evaluations){
            $.ajax({
                url: host + '/index.php?app=buyer_order&act=ejEvaluate&order_id='+orderId+'&evaluations='+evaluations+'&desc_stars='+desc_stars+'&logi_stars='+logi_stars+'&serv_stars='+serv_stars+'',
                type: "post",
                success: function (rs) {
                    if(rs.code == 0){
                        allFun.alertDiv(rs.msg);
                    }else{
                        allFun.alertDiv(rs.msg);
                    }

                }
            });
        }


</script>
</html>