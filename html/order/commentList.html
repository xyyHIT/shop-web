<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>评价列表</title>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no">
    <script src="/shop/js/rem.js"></script>
    <link href="/shop/css/base.css" rel="stylesheet" type="text/css" />
    <link href="/shop/css/font/iconfont.css" rel="stylesheet" type="text/css" />
    <link href="/shop/css/order.css" rel="stylesheet" type="text/css" />
    <style>
        .list{background: #fff;margin:1rem;overflow: hidden;border-radius:10px;  padding-bottom:1rem;}
        .list .boxs{ overflow:hidden; padding-bottom:.5rem; }
        .list .boxs .boxList {padding:1rem 1rem 0 1rem ; position: relative}
        .list .boxs .boxList .content{height:3rem; line-height:3rem; font-size:1.1rem; color:#333;}
        .list .boxs .boxList .date{ position: absolute; right:1rem; top:.5rem ;font-size:1rem; color:#999;}
        .list .boxs ul{padding:1rem .7rem 0;}
        .list .boxs ul li{float: left; width:33.33%; height:9rem; padding:0 .3rem;}
        .list .boxs ul li img{width:100%;}
        .boxList span img{ width: 4rem;  height: 4rem;  border-radius: 100%; float: left;margin-right: 1.5rem;}
        .boxList span.level img { display: inline-block;  margin-top: .1rem;  float: left;  margin-right: .5rem;  background-size: 1.5rem 1.5rem;  height: 1.5rem;  width: 1.5rem;}

        .reply{background:#ededed; margin:0 1rem; cilor:#999; padding:1rem;}
    </style>
</head>
<body>
<div class="container">

    <nav class="nav5">
        <a data_type="0">全部</a><a data_type="3">好<em>(1)</em></a><a data_type="2">一般<em>(11)</em></a><a data_type="1">差<em>(1212)</em></a><a data_type="4">有图<em>(1)</em></a>
    </nav>
    <div class="list">
       <!-- <div class='boxs'>
            <div class="boxList">
                    <div><span><a href="javascript:;"><img src=""></a></span><span class="level"></span><span>sdsdsdsd</span></div>
                    <div class="content">该唱片的的质量有点暴躁考点附近路口的房间看到了福....</div>
                    <div class="date">2017-01-23</div>
            </div>
            <ul>
                <li><img src='../../imgs/test/0.jpg' /></li><li><img src='../../imgs/test/0.jpg' /></li><li><img src='../../imgs/test/0.jpg' /></li>
            </ul>

        </div>

        <div class="reply">
            店家回复：福建分行经理看粉红色看警方很快锁定
        </div>-->

    </div>
</div>
</body>

<script src="/shop/js/jquery-2.1.4.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="/shop/js/public.js"></script>
<script src="/shop/js/order.js"></script>
<script src="/shop/js/fastclick.js"></script>
<script>
    var goodsId = allFun.getRequest("goodsId");//商品id
        evaluation = allFun.getRequest("evaluation");//tab类型
        curr_page = 1;
        finished = true;
    if(!evaluation){
        evaluation = 0;
    }
    $(function () {
        //缓存
        if(sessionStorage.getItem("commentListShopStorage") && allFun.getRequest("history") == -1){
            var commentListShopStorage = JSON.parse(sessionStorage.getItem("commentListShopStorage"));
            evaluation = commentListShopStorage.evaluation;
           //getOrderList(linkType);
            sessionStorage.removeItem("commentListShopStorage");
        }else{
            sessionStorage.removeItem("commentListShopStorage");
            getCommentList(goodsId,evaluation);
        }



        $("nav a").each(function(){
            if($(this).attr("data_type") == evaluation){
                $(this).addClass("on").siblings().removeClass("on");
            }
        });

        //tab切换
        $("nav a").click(function () {
            evaluation = $(this).attr("data_type");
            console.log(evaluation);
            $(this).addClass("on").siblings().removeClass("on");
            $(".list").empty();
            curr_page = 1;
            getCommentList(goodsId,evaluation);
        });
        //点击查看更多
        $(window).on('scroll', function () {
            var dHeight = document.documentElement.offsetHeight;
            var sHeight = document.documentElement.scrollTop || document.body.scrollTop;
            var wHeight = document.documentElement.clientHeight;
            if (finished && dHeight - (sHeight + wHeight) < 200) {
                finished = false;
                if($(".seemore").attr("data_d") != "no"){
                    curr_page++;
                    getCommentList(goodsId,evaluation);
                }
            }
        });



    });
    function getCommentList(id,evaluation){//evaluation类别   （评论类别: 0 => 所有 1 => 差评 2 => 中评 3 => 好评 4 => 有图）

        $.ajax({
            url: host + "/index.php?app=goods&act=ejComments&evaluation="+evaluation+"&id="+goodsId+"&page="+curr_page+"",
            type: "get",
            dataType: "json",
            beforeSend:function(){
                if(curr_page == 1){//第一次
                    allFun.loading();
                }
            },
            success: function(rs) {
                allFun.removeLoading();
                if(rs.code == 0) {
                    $(".seemore").remove();
                    curr_page = rs.data.page_info.curr_page;
                    finished = true;
                    var obj = '',
                        d = rs.data.comments;
                        item_count = rs.data.page_info.item_count;//总条数
                        pageper = rs.data.page_info.pageper;//每页条数
                        $.each(d,function (j,v) {
                            obj+='<div class="boxs"><div class="boxList">'
                                +'<div><span><a href="javascript:;"><img src="'+v.portrait+'"></a></span><span class="level"><img src="/shop/imgs/level/saler'+v.level+'.png"></span><span>'+v.buyer_name+'</span></div>'
                                +'<div class="content">'+v.comment+'</div>'
                                +'<div class="date">'+v.evaluation_time+'</div>'
                                +'</div>'
                                +'<ul>';

                                    for(var u=0;u<v.imgs.length;u++){
                                        obj +='<li><img src="'+v.imgs[u]+'" /></li>'
                                    }
                                obj +='</ul>';
                                obj +='</div>';
                             if(v.reply!=""){
                                 obj+='<div class="reply">店家回复：'+v.reply+'  </div>'

                             }else {
                                 $(".reply").hide();
                             }

                            if(curr_page < Math.ceil(item_count/pageper)){//有数据
                                obj += "<div class='seemore'><div class='com-loading'><div></div></div>拼命加载中</div>";
                            }else{//没有更多数据
                                obj += "<div class='seemore' data_d='no'></div>";
                            }
                        });
                    $(".list").html(obj);


                } else {
                    allFun.alertDiv(rs.msg);
                }
            },
            error: function() {
                allFun.removeLoading();
                allFun.alertDiv("error!")
            }
        })
    }
</script>
</html>